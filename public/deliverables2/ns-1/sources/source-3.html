


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > Leaderboard</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">io.github.glitchgobblers</a>
</div>

<h1>Coverage Summary for Class: Leaderboard (io.github.glitchgobblers)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">Leaderboard</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (6/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    32.1%
  </span>
  <span class="absValue">
    (18/56)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    62.9%
  </span>
  <span class="absValue">
    (39/62)
  </span>
</td>
</tr>
  <tr>
    <td class="name">Leaderboard$Entry</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    66.7%
  </span>
  <span class="absValue">
    (4/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (10/10)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (9/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    35.5%
  </span>
  <span class="absValue">
    (22/62)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    68.1%
  </span>
  <span class="absValue">
    (49/72)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package io.github.glitchgobblers;
&nbsp;
&nbsp;import com.badlogic.gdx.Gdx;
&nbsp;import com.badlogic.gdx.files.FileHandle;
&nbsp;import com.badlogic.gdx.utils.Array;
&nbsp;import com.badlogic.gdx.utils.Json;
&nbsp;import com.badlogic.gdx.utils.ObjectMap;
&nbsp;import com.badlogic.gdx.utils.TimeUtils;
&nbsp;
&nbsp;public class Leaderboard {
&nbsp;
&nbsp;  private static final String FILE_NAME = &quot;leaderboard.json&quot;;
&nbsp;
&nbsp;  private final Json json;
&nbsp;
<b class="fc">&nbsp;  public Leaderboard() {</b>
<b class="fc">&nbsp;    json = new Json();</b>
<b class="fc">&nbsp;    json.setTypeName(null);</b>
<b class="fc">&nbsp;    json.setIgnoreUnknownFields(true);</b>
&nbsp;  }
&nbsp;
&nbsp;  public static class Entry implements Comparable&lt;Entry&gt; {
&nbsp;    public String id;     // UUID
&nbsp;    public String name;   // display name
&nbsp;    public int score;     // best score
&nbsp;    public long ts;       // timestamp
&nbsp;
<b class="fc">&nbsp;    public Entry() {}</b>
&nbsp;
<b class="fc">&nbsp;    public Entry(String id, String name, int score, long ts) {</b>
<b class="fc">&nbsp;      this.id = id;</b>
<b class="pc">&nbsp;      this.name = (name == null || name.isEmpty()) ? &quot;Anonymous&quot; : name.trim();</b>
<b class="fc">&nbsp;      this.score = score;</b>
<b class="fc">&nbsp;      this.ts = ts;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public int compareTo(Entry o) {
<b class="fc">&nbsp;      int s = Integer.compare(o.score, this.score);</b>
&nbsp;
<b class="fc">&nbsp;      if (s != 0) {</b>
<b class="fc">&nbsp;        return s;</b>
&nbsp;      }
&nbsp;
<b class="fc">&nbsp;      return Long.compare(o.ts, this.ts);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  // we have to suppress this, we can&#39;t fix it
&nbsp;  @SuppressWarnings(&quot;unchecked&quot;)
&nbsp;  public Array&lt;Entry&gt; load() {
<b class="fc">&nbsp;    FileHandle fh = Gdx.files.local(FILE_NAME);</b>
<b class="pc">&nbsp;    if (!fh.exists()) {</b>
<b class="nc">&nbsp;      return new Array&lt;&gt;();</b>
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    String raw = fh.readString(&quot;UTF-8&quot;);</b>
&nbsp;    Array&lt;Entry&gt; entries;
&nbsp;
&nbsp;    try {
<b class="fc">&nbsp;      entries = json.fromJson(Array.class, Entry.class, raw);</b>
&nbsp;    } catch (Exception ex) {
<b class="nc">&nbsp;      Gdx.app.error(&quot;Leaderboard&quot;, &quot;Parse failed. NOT overwriting file.&quot;, ex);</b>
<b class="nc">&nbsp;      return new Array&lt;&gt;(); // do not save() on failure</b>
&nbsp;    }
&nbsp;
<b class="pc">&nbsp;    if (entries == null) {</b>
<b class="nc">&nbsp;      entries = new Array&lt;&gt;();</b>
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    entries = mergeById(entries);</b>
<b class="fc">&nbsp;    entries.sort();</b>
&nbsp;
<b class="fc">&nbsp;    return entries;</b>
&nbsp;  }
&nbsp;
&nbsp;  private Array&lt;Entry&gt; mergeById(Array&lt;Entry&gt; entries) {
<b class="fc">&nbsp;    ObjectMap&lt;String, Entry&gt; map = new ObjectMap&lt;&gt;();</b>
&nbsp;
<b class="fc">&nbsp;    for (Entry e : entries) {</b>
<b class="pc">&nbsp;      if (e == null || e.id == null || e.id.isEmpty()) {</b>
&nbsp;        continue;
&nbsp;      }
&nbsp;
<b class="fc">&nbsp;      Entry existing = map.get(e.id);</b>
<b class="pc">&nbsp;      if (existing == null) {</b>
<b class="fc">&nbsp;        map.put(e.id, e);</b>
&nbsp;      } else {
<b class="nc">&nbsp;        if (e.score &gt; existing.score) {</b>
<b class="nc">&nbsp;          existing.score = e.score;</b>
<b class="nc">&nbsp;          existing.ts = e.ts;</b>
<b class="nc">&nbsp;          existing.name = (e.name == null || e.name.isEmpty()) ? existing.name : e.name;</b>
<b class="nc">&nbsp;        } else if (e.score == existing.score &amp;&amp; e.ts &gt; existing.ts) {</b>
<b class="nc">&nbsp;          existing.ts = e.ts;</b>
&nbsp;
<b class="nc">&nbsp;          if (e.name != null &amp;&amp; !e.name.isEmpty()) {</b>
<b class="nc">&nbsp;            existing.name = e.name;</b>
&nbsp;          }
<b class="nc">&nbsp;        } else if (e.ts &gt; existing.ts &amp;&amp; e.name != null &amp;&amp; !e.name.isEmpty()) {</b>
<b class="nc">&nbsp;          existing.name = e.name;</b>
<b class="nc">&nbsp;          existing.ts = e.ts;</b>
&nbsp;        }
&nbsp;      }
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    return new Array&lt;&gt;(map.values().toArray());</b>
&nbsp;  }
&nbsp;
&nbsp;  private void save(Array&lt;Entry&gt; entries) {
<b class="fc">&nbsp;    entries.sort();</b>
<b class="pc">&nbsp;    while (entries.size &gt; 100) {</b>
<b class="nc">&nbsp;      entries.pop();</b>
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    String jsonOut = json.prettyPrint(json.toJson(entries, Array.class, Entry.class));</b>
<b class="fc">&nbsp;    Gdx.files.local(FILE_NAME).writeString(jsonOut, false, &quot;UTF-8&quot;);</b>
&nbsp;  }
&nbsp;
&nbsp;  public void submit(String id, String name, int score) {
<b class="pc">&nbsp;    if (id == null || id.isEmpty()) {</b>
&nbsp;      return;
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    Array&lt;Entry&gt; entries = load();</b>
&nbsp;
<b class="fc">&nbsp;    Entry hit = null;</b>
<b class="fc">&nbsp;    for (Entry e : entries) {</b>
<b class="pc">&nbsp;      if (id.equals(e.id)) {</b>
<b class="nc">&nbsp;        hit = e;</b>
&nbsp;        break;
&nbsp;      }
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    long now = TimeUtils.millis();</b>
&nbsp;
<b class="pc">&nbsp;    if (hit == null) {</b>
<b class="fc">&nbsp;      entries.add(new Entry(id, name, score, now));</b>
&nbsp;    } else {
<b class="nc">&nbsp;      if (score &gt; hit.score) {</b>
<b class="nc">&nbsp;        hit.score = score;</b>
<b class="nc">&nbsp;        hit.ts = now;</b>
&nbsp;      }
<b class="nc">&nbsp;      if (name != null &amp;&amp; !name.isEmpty()) {</b>
<b class="nc">&nbsp;        hit.name = name;</b>
&nbsp;      }
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    save(entries);</b>
&nbsp;  }
&nbsp;
&nbsp;  public Array&lt;Entry&gt; top(int n) {
<b class="fc">&nbsp;    Array&lt;Entry&gt; entries = load();</b>
<b class="fc">&nbsp;    entries.sort();</b>
<b class="pc">&nbsp;    if (entries.size &lt;= n) {</b>
<b class="nc">&nbsp;      return entries;</b>
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    Array&lt;Entry&gt; out = new Array&lt;&gt;(n);</b>
<b class="fc">&nbsp;    for (int i = 0; i &lt; n; i++) {</b>
<b class="fc">&nbsp;      out.add(entries.get(i));</b>
&nbsp;    }
<b class="fc">&nbsp;    return out;</b>
&nbsp;  }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-01-02 16:28</div>
</div>
</body>
</html>
